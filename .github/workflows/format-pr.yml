name: Format PR Files

on:
  pull_request:
    types:
      - opened
    paths:
      - '**/*.md'

permissions:
  contents: write  # Ensure GITHUB_TOKEN has push permissions

jobs:
  whitespace:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}  # Main repository
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Add PR author's remote repository
        run: |
          # Add the PR author's repository as an upstream remote
          git remote add upstream ${{ github.event.pull_request.head.repo.clone_url }}
          git fetch upstream ${{ github.event.pull_request.head.ref }}
          git checkout -b pr-branch upstream/${{ github.event.pull_request.head.ref }}

      - name: Set up Git config
        run: |
          # Configure Git user information
          git config --global user.name "miyaliu666"
          git config --global user.email "miyaliu@gmail.com"

      - name: Remove trailing whitespaces from Markdown files
        run: |
          echo "Checking Markdown files for trailing whitespaces..."

          # Get all .md files that have changed
          files=$(git ls-files | grep '\.md$')
          echo "Markdown files: $files"

          if [ -n "$files" ]; then
            echo "Processing files..."
            for file in $files; do
              echo "Fixing file: $file"
              sed -i 's/ $//g' "$file"  # Remove trailing whitespaces
              git add "$file"           # Stage changes
            done

            # Commit and push changes
            git commit -m "fix: Remove trailing whitespaces from Markdown files"
            git push upstream HEAD:${{ github.event.pull_request.head.ref }}
          else
            echo "No Markdown files to process or no changes detected."
          fi
