name: Format PR Files

on:
  pull_request:
    types:
      - opened
    paths:
      - '**/*.md'  # Trigger workflow only when .md files are modified in the PR

permissions:
  contents: write  # Enable write permissions for pushing changes

jobs:
  whitespace:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Set up Git config
        run: |
          git config --global user.name "miyaliu666"
          git config --global user.email "miyaliu66666@gmail.com"

      - name: Remove trailing whitespaces from Markdown files
        run: |
          echo "Target branch: ${{ github.event.pull_request.base.ref }}"
          echo "Head branch: ${{ github.event.pull_request.head.ref }}"

          base_branch="${{ github.event.pull_request.base.ref }}"
          head_branch="${{ github.event.pull_request.head.ref }}"

          # Fetch the base and head branches
          git fetch origin $base_branch
          git fetch origin $head_branch

          # Determine the base commit shared by the base and head branches
          base_commit=$(git merge-base origin/$base_branch origin/$head_branch)
          echo "Base commit: $base_commit"

          # Get the changed files in the current PR
          echo "Checking changes in PR..."
          files=$(git diff --name-only $base_commit HEAD)
          echo "Changed files: $files"

          # Filter out only .md files
          file=$(echo "$files" | grep '\.md$')
          if [ -n "$file" ]; then
            echo "Filtered .md file(s): $file"
            for f in $file; do
              echo "Processing file: $f"
              # Remove trailing spaces from each line in the file
              sed -i 's/ $//g' "$f"
              # Check if changes were made
              if git diff --exit-code "$f"; then
                echo "No changes detected in $f"
              else
                git add "$f"
                echo "Changes staged for $f"
              fi
            done

            # Commit and push changes if there are any
            if git diff --cached --exit-code; then
              echo "No changes to commit."
              exit 0
            fi
            git commit -m "Remove trailing spaces from Markdown files"
            git push origin HEAD:$head_branch
          else
            echo "No Markdown files found or no changes to commit."
            exit 0
          fi
